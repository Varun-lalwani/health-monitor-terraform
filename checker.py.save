import time
import requests
import logging

from db import (
    get_apis_to_check,
    insert_health_result,
    get_health_state,
    update_health_state
)
from notifier import send_notification
from evaluator import evaluate_health

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(message)s',
)
logger = logging.getLogger(__name__)  # this makes logger available everywhere in checker.py including check_api() and main())

def check_api(api):
    """
    Perform health check for a single API.
    """
    #Initialize variables
    status_code = None
    response_time_ms = 0
    success = False
    
    # Performing HTTP request
    try:
        start_time = time.time()
        response = requests.get(
            api["url"],
            timeout=api["timeout_seconds"]
        )
        response_time_ms = int((time.time() - start_time) * 1000)
        status_code = response.status_code
        success = status_code == api["expected_status"]

    except requests.Timeout:
        logger.error(f"[TIMEOUT] {api['name']}")

    except requests.RequestException as e:
        logger.error(f"[ERROR] {api['name']} - {e}")

    # Store health result (audit/history)
    insert_health_result(
        api_id=api["id"],
        status_code=status_code,
        response_time_ms=response_time_ms,
        success=success
    )

    # Fetch current health state
    state = get_health_state(api["id"])

    # Initialize state if first run
    if state is None:
        update_health_state(api["id"], "HEALTHY", 0)
        state = {"current_state": "HEALTHY", "consecutive_failures": 0}

        evaluation = evaluate_health(api, state, success)  
        # Skip notification on first run
        notify = False
    else:
        evaluation = evaluate_health(api, state, success)
        notify = evaluation["state_changed"]

    # Notify only on state changed
    if evaluation["state_changed"]:
        send_notification(
            api["name"],
            state["current_state"],
            evaluation["new_state"]
        )

        # send actual notification (email / console)
        send_notification(
        api["name"],
        state["current_state"],
        evaluation["new_state"]
    )
        logger.info(f"State change for {api['name']}: {state['current_state']} -> {evaluation['new_state']}")
    #log check info 
    logger.info(f"checked {api['name']}- Success={success}, ResponseTime={response_time_ms}ms")

    # Update health state in DB
    update_health_state(
        api_id=api["id"],
        new_state=evaluation["new_state"],
        consecutive_failures=evaluation["consecutive_failures"]
    )


def main():
    logger.info("ðŸš€ API Health Monitor started...")

    while True:
        apis = get_apis_to_check()

        for api in apis:
            check_api(api)

        # Global loop delay (can later use per-API interval)
        time.sleep(10)


if __name__ == "__main__":
    main()
